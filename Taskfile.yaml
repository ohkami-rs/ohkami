version: 3

vars:
  native_rts: 'tokio smol nio glommio monoio compio'
  non_wasm_rts: 'lambda {{.native_rts}}'
  all_rts: 'worker {{.non_wasm_rts}}'
  maybe_nightly: { sh: cargo version | grep -q 'nightly' && echo 'nightly' || echo '' }
  coverage_features: 'DEBUG,rt_tokio,sse,ws,tls,openapi'
  github_pages_dir: 'site'

tasks:
  CI:
    deps:
      - task: test
      - task: check
      - task: bench:dryrun

  test:
    deps:
      - task: test:core
      - task: test:other
  test:core:
    deps:
      - task: test:no_rt
      - for:  { var: all_rts }
        vars: { rt: '{{.ITEM}}' }
        task: test:rt
  test:other:
    deps:
      - task: test:deps
      - task: test:doc
      - task: test:examples
      - task: test:samples

  check:
    deps:
      # - task: check:fmt  #### WORKAROUND for rustfmt panic ####
      - task: check:no_rt
      - for:  { var: non_wasm_rts }
        vars: { rt: '{{.ITEM}}' }
        task: check:non_wasm_rt
      - task: check:rt_worker

  bench:dryrun:
    status:
      - '[ "{{.maybe_nightly}}" != nightly ]' # skip if not nightly
    cmds:
      - cd benches && cargo bench --features DEBUG --no-run
      - for: { var: native_rts }
        cmd: cd benches_rt/{{.ITEM}} && cargo check
  bench:
    status:
      - '[ "{{.maybe_nightly}}" != nightly ]' # skip if not nightly
    cmds:
      - task: bench:dryrun
      - cd benches && cargo bench --features DEBUG

#### tests ####
  test:deps:
    cmds:
      - cargo test -p ohkami_lib
      - cargo test -p ohkami_openapi

  test:doc:
    dir: ./ohkami
    cmds:
      - cargo test --doc --no-default-features --features DEBUG,rt_tokio,sse,ws,tls,{{.maybe_nightly}}
      # not activating `openapi` feature for testability of README sample codes

  test:examples:
    dir: ./examples
    cmds:
      - chmod +x ./test.sh
      - ./test.sh

  test:samples:
    dir: ./samples
    cmds:
      - chmod +x ./test.sh
      - ./test.sh

  test:no_rt:
    dir: ./ohkami
    cmds:
      - cargo test --lib --features DEBUG,{{.maybe_nightly}}
      - cargo test --lib --features DEBUG,sse,{{.maybe_nightly}}
      - cargo test --lib --features DEBUG,ws,{{.maybe_nightly}}
      - cargo test --lib --features DEBUG,sse,ws,openapi,{{.maybe_nightly}}

  test:rt:
    dir: ./ohkami
    cmds:
      - cargo test --lib --features rt_{{.rt}},DEBUG,{{.maybe_nightly}}
      - cargo test --lib --features rt_{{.rt}},DEBUG,sse,{{.maybe_nightly}}
      - cargo test --lib --features rt_{{.rt}},DEBUG,ws,{{.maybe_nightly}}
      - cargo test --lib --features rt_{{.rt}},DEBUG,sse,ws,openapi,{{.maybe_nightly}}
      - cargo test --lib --features rt_{{.rt}},DEBUG,tls,{{.maybe_nightly}}
      - cargo test --lib --features rt_{{.rt}},DEBUG,sse,ws,tls,{{.maybe_nightly}}

#### checks ####
  check:fmt:
    cmds:
      - cargo fmt --all --check

  check:no_rt:
    vars:
      features_nightly_or_empty:
        sh: test "{{.maybe_nightly}}" && echo '--features nightly' || echo ''
    cmds:
      - cargo clippy --all-targets {{.features_nightly_or_empty}} -- --deny warnings
      - cargo clippy --all-targets --features sse,{{.maybe_nightly}} -- --deny warnings
      - cargo clippy --all-targets --features ws,{{.maybe_nightly}} -- --deny warnings
      - cargo clippy --all-targets --features sse,ws,openapi,{{.maybe_nightly}} -- --deny warnings

  check:non_wasm_rt:
    cmds:
      - cargo clippy --all-targets --features rt_{{.rt}},{{.maybe_nightly}} -- --deny warnings
      - cargo clippy --all-targets --features rt_{{.rt}},sse,{{.maybe_nightly}} -- --deny warnings
      - cargo clippy --all-targets --features rt_{{.rt}},ws,{{.maybe_nightly}} -- --deny warnings
      - cargo clippy --all-targets --features rt_{{.rt}},sse,ws,openapi,{{.maybe_nightly}} -- --deny warnings
      - cargo clippy --all-targets --features rt_{{.rt}},tls,{{.maybe_nightly}} -- --deny warnings
      - cargo clippy --all-targets --features rt_{{.rt}},sse,ws,tls,{{.maybe_nightly}} -- --deny warnings

  check:rt_worker:
    cmds:
      - cargo clippy --target wasm32-unknown-unknown --features rt_worker,{{.maybe_nightly}} -- --deny warnings
      - cargo clippy --target wasm32-unknown-unknown --features rt_worker,sse,{{.maybe_nightly}} -- --deny warnings
      - cargo clippy --target wasm32-unknown-unknown --features rt_worker,ws,{{.maybe_nightly}} -- --deny warnings
      - cargo clippy --target wasm32-unknown-unknown --features rt_worker,sse,ws,openapi,{{.maybe_nightly}} -- --deny warnings

#### coverage ####
  coverage:html:
    deps: [ tools:coverage ]
    cmds:
      - cargo llvm-cov clean --workspace
      - cargo llvm-cov --html --workspace --features {{.coverage_features}}
    generates:
      - target/llvm-cov/html/index.html

#### GiHub Pages ####
  pages:build:
    cmds:
      - task: pages:build:coverage

  pages:build:coverage:
    deps: [ tools:coverage ]
    vars:
      coverage_dir: '{{.github_pages_dir}}/coverage'
    cmds:
      # setup
      - rm -rf {{.coverage_dir}}; mkdir -p {{.coverage_dir}}
      - chmod +x ./scripts/generate_coverage_badge.sh
      - cargo llvm-cov clean --workspace
      # file generation
      - |
        cargo llvm-cov --workspace --features {{.coverage_features}} --html --output-dir {{.coverage_dir}} \
          && mv {{.coverage_dir}}/html/* {{.coverage_dir}}/ \
          && rm -rf {{.coverage_dir}}/html
      - |
        cargo llvm-cov --workspace --features {{.coverage_features}} --json \
          | ./scripts/generate_coverage_badge.sh -o {{.github_pages_dir}}/coverage_badge.json

#### tools ####
  tools:
    deps:
      - tools:coverage
      
  tools:coverage:
    cmds:
      - rustup component add llvm-tools-preview
      - cargo install cargo-llvm-cov
    status:
      - rustup component list --installed | grep -q 'llvm-tools'
      - command -qv cargo-llvm-cov
